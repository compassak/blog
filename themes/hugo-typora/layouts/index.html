{{ define "main" }}
<div class="homepage-wrapper">
    <!-- Particle Effect Container (z-index: 0, below content) -->
    <div id="particle-container"></div>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">
                {{ with .Site.Params.hero.title }}{{ . | safeHTML }}{{ else }} title {{ end }}
            </h1>
            <p class="hero-description">
                {{ with .Site.Params.hero.description }}{{ . }}{{ else }}description{{ end }}
            </p>
        </div>
    </section>

    <!-- Recent Posts Grid -->
    <section id="posts-grid" class="posts-grid-container">
        <div class="posts-grid">
            {{ range first 20 .Site.RegularPages }}
            <a href="{{ .RelPermalink }}" class="post-card">
                {{ $img := (.Resources.ByType "image").GetMatch "*featured*" }}
                {{ with $img }}
                <div class="post-card-image">
                    <img src="{{ .RelPermalink }}" alt="{{ $.Title }}">
                </div>
                {{ end }}
                <div class="post-card-content">
                    <div class="post-card-meta">
                        <span class="post-date">{{ .Date.Format "2006-01-02" }}</span>
                        {{ with .Params.categories }}
                        <span class="post-category">{{ index . 0 }}</span>
                        {{ end }}
                    </div>
                    <h3 class="post-card-title">{{ .Title }}</h3>
                    <p class="post-card-summary">{{ .Summary | truncate 100 }}</p>
                    <span class="read-more">Read more &rarr;</span>
                </div>
            </a>
            {{ end }}
        </div>
    </section>
</div>

<!-- Canvas 2D Particle Effect -->
<script>
    (function () {
        const container = document.getElementById('particle-container');
        if (!container) return;

        const canvas = document.createElement('canvas');
        canvas.id = 'particle-canvas';
        container.appendChild(canvas);
        const ctx = canvas.getContext('2d');

        let width, height;
        let particles = [];

        // 配置参数
        const config = {
            count: 1200,
            colorActive: {r: 66, g: 133, b: 244},
            colorDormant: {r: 80, g: 80, b: 80},
            thicknessDormant: 1.8,
            thicknessActive: 3.8,
            lengthStretch: 4.0,
            baseRadius: 200,
            ringThickness: 300,
            breathSpeed: 0.002,
            breathAmp: 80,
            distortionStrength: 60,
            distortionFreq: 4.0,
            mouseLag: 0.05,
            particleLerp: 0.08
        };

        let targetMouse = { x: -1000, y: -1000 };
        let renderMouse = { x: -1000, y: -1000 };
        let time = 0;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        function lerp(start, end, amt) {
            return start * (1 - amt) + end * amt;
        }

        function noise1D(x) {
            return Math.sin(x) * 0.5 + Math.sin(x * 2.3) * 0.25 + Math.sin(x * 4.7) * 0.125;
        }

        class Particle {
            constructor() {
                this.baseX = Math.random() * width;
                this.baseY = Math.random() * height;
                this.currentX = this.baseX;
                this.currentY = this.baseY;
                this.intensity = 0;
                this.layerOffset = Math.random() * config.ringThickness;
            }

            update() {
                const dxBase = this.baseX - renderMouse.x;
                const dyBase = this.baseY - renderMouse.y;
                const distBase = Math.sqrt(dxBase * dxBase + dyBase * dyBase);
                const angleBase = Math.atan2(dyBase, dxBase);

                const breath = Math.sin(time * config.breathSpeed) * config.breathAmp;
                const distortion = noise1D(angleBase * config.distortionFreq + time * 0.001) * config.distortionStrength;
                const currentBaseRadius = config.baseRadius + breath + distortion;

                let targetX = this.baseX;
                let targetY = this.baseY;
                let targetIntensity = 0;

                const maxTriggerRadius = currentBaseRadius + config.ringThickness;

                if (distBase < maxTriggerRadius) {
                    const myTargetRadius = currentBaseRadius + this.layerOffset;
                    const moveDist = myTargetRadius - distBase;
                    
                    targetX = this.baseX + Math.cos(angleBase) * moveDist;
                    targetY = this.baseY + Math.sin(angleBase) * moveDist;
                    
                    targetIntensity = 1 - (distBase / maxTriggerRadius);
                    targetIntensity = Math.pow(targetIntensity, 0.5);
                    
                    if (targetIntensity < 0.8) targetIntensity = 0.8 + Math.random() * 0.2;
                }

                this.currentX = lerp(this.currentX, targetX, config.particleLerp);
                this.currentY = lerp(this.currentY, targetY, config.particleLerp);
                this.intensity = lerp(this.intensity, targetIntensity, config.particleLerp);

                this.angle = Math.atan2(renderMouse.y - this.currentY, renderMouse.x - this.currentX);

                const r = Math.floor(config.colorDormant.r + (config.colorActive.r - config.colorDormant.r) * this.intensity);
                const g = Math.floor(config.colorDormant.g + (config.colorActive.g - config.colorDormant.g) * this.intensity);
                const b = Math.floor(config.colorDormant.b + (config.colorActive.b - config.colorDormant.b) * this.intensity);
                const alpha = 0.6 + 0.4 * this.intensity;

                this.color = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                this.thickness = config.thicknessDormant + (config.thicknessActive - config.thicknessDormant) * this.intensity;
                this.length = config.lengthStretch * this.intensity;
            }

            draw() {
                if (this.currentX < -50 || this.currentX > width + 50 || 
                    this.currentY < -50 || this.currentY > height + 50) return;

                ctx.save();
                ctx.translate(this.currentX, this.currentY);
                ctx.rotate(this.angle);
                
                ctx.beginPath();
                ctx.strokeStyle = this.color;
                ctx.lineWidth = this.thickness;
                ctx.lineCap = 'round';
                
                ctx.moveTo(-this.length / 2, 0);
                ctx.lineTo(this.length / 2, 0);
                ctx.stroke();
                
                ctx.restore();
            }
        }

        function init() {
            resize();
            particles = [];
            for (let i = 0; i < config.count; i++) {
                particles.push(new Particle());
            }
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            time = Date.now();
            renderMouse.x = lerp(renderMouse.x, targetMouse.x, config.mouseLag);
            renderMouse.y = lerp(renderMouse.y, targetMouse.y, config.mouseLag);

            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }

        document.addEventListener('mousemove', e => {
            targetMouse.x = e.clientX;
            targetMouse.y = e.clientY;
        });
        document.addEventListener('mouseleave', () => {
            targetMouse.x = -2000;
            targetMouse.y = -2000;
        });
        window.addEventListener('resize', () => {
            resize();
            init();
        });

        init();
        animate();
    })();
</script>

<style>
    #particle-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
    }

    #particle-container canvas {
        display: block;
    }
</style>
{{ end }}